system(paste("/home/carloslima/tools/ncbi-blast-2.15.0+/bin//blastn -query", paste0(path, tax_sequences),  "-db", paste0(path, vert_fasta), "-outfmt '6 qseq qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore' -max_target_seqs 1 -out", paste0(path, blastout)))
blasttable <- read.table(paste0(path, blastout))
colnames(blasttable) <- c("qseq", "qid", "sid", "pident", "length", "mismatch", "gapopen", "qstart", "qend", "sstart", "send", "evalue", "bitscore")
paste("/home/carloslima/tools/ncbi-blast-2.15.0+/bin//blastn -query", paste0(path, tax_sequences),  "-db", paste0(path, vert_fasta), "-outfmt 6 -max_target_seqs 1 -out", paste0(path, blastout))
blastresults <- blasttable %>%
filter(pident == 100) %>%
select(qid, sid) %>%
data.frame()
taxtab <- data.frame(seqs = colnames(otab), stringsAsFactors = FALSE) %>%
left_join(blastresults, by=c('seqs'='qid'))
taxtab$taxa <- taxtab$sid
rownames(taxtab) <- taxtab$seqs
taxtab <- taxtab %>%
select(-seqs, -sid) %>%
as.matrix() %>%
tax_table
ps <- phyloseq(otab, taxtab)
system(paste("echo Done! Now plotting most abundant taxonomies by sample..."))
toptaxa <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:5]
ps.toptaxa <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.toptaxa <- prune_taxa(toptaxa, ps.toptaxa)
for (sample_name in row.names(otu_table(ps.toptaxa))){
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
png(filename = paste0(path, "data/images/plots/", sample_name, "_toptaxa.png"), width = 800, height = 600)
plot_bar(ps.toptaxa_sample, x = "taxa", y = "Abundance", fill = "taxa", title = paste0("Most abundant taxa for sample ",sample_name))
dev.off()
}
system(paste("echo Saving taxonomy table and blast output..."))
tax_table1<-"data/taxtable.txt"
write.table(taxtab, file=paste0(path,tax_table1))
tax_tablecsv<-"data/taxtable.csv"
write.csv(taxtab, file=paste0(path,tax_tablecsv)) # just so it can be easily read by excel
# same thing for blasttable
blasttable <- read.table(paste0(path, blastout))
colnames(blasttable) <- c("qseq", "qid", "sid", "pident", "length", "mismatch", "gapopen", "qstart", "qend", "sstart", "send", "evalue", "bitscore")
blast_out<-"data-raw/blastout.csv"
write.csv(blasttable,file=paste0(path,blast_out))
system(paste("echo ##### Analysis Complete #####"))
create_report <- function(sample,top,sec){
rmarkdown::render(input = paste0(path0,"/MitoSonar_report.Rmd"),
output_format = rmarkdown::pdf_document(),
output_file = paste0(sample,"_MSReport"),
output_dir = paste0(path,"reports"),
intermediates_dir = paste0(path,"reports"),
clean = TRUE,
params = list(sample = sample,
maxN = maxN,
truncQ = truncQ,
truncLen = truncLen,
trimLeft = trimLeft,
maxEE = maxEE,
species = top,
species2 = sec))
}
rep_dir <- paste0(path,"reports")
if(!dir.exists(rep_dir)){dir.create(rep_dir)}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"work-dir"))
system(paste0("rm -r ",path,"reports/work-dir"))
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"reports/work-dir"))
estimErrPng <- function(dadaObj,samId,sample_dir,acgtBase) {
png(filename = paste0(sample_dir,"/",samId,"_estimErr_",acgtBase,".png"), width = 800, height = 600)
plot <- plotErrors(dadaObj, acgtBase, nominalQ=TRUE)
print(plot)
dev.off()
}
if (length(dadaFs) > 1) {
i=1
while (i <= length(sam_names)) {
sample_dir <- paste0(path,"data/images/plots/",sam_names[i],"_estimated_errors")
if(!dir.exists(sample_dir)){dir.create(sample_dir)}
estimErrPng(dadaFs[[i]],sam_names[i],sample_dir,"A")
estimErrPng(dadaFs[[i]],sam_names[i],sample_dir,"C")
estimErrPng(dadaFs[[i]],sam_names[i],sample_dir,"G")
estimErrPng(dadaFs[[i]],sam_names[i],sample_dir,"T")
i=i+1
}
}else {
sample_dir <- paste0(path,"data/images/plots/",sam_names,"_estimated_errors")
if(!dir.exists(sample_dir)){dir.create(sample_dir)}
estimErrPng(dadaFs,sam_names,sample_dir,"A")
estimErrPng(dadaFs,sam_names,sample_dir,"C")
estimErrPng(dadaFs,sam_names,sample_dir,"G")
estimErrPng(dadaFs,sam_names,sample_dir,"T")
}
warnings()
system(paste("echo Done! Now plotting most abundant taxonomies by sample..."))
toptaxa <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:5]
ps.toptaxa <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.toptaxa <- prune_taxa(toptaxa, ps.toptaxa)
for (sample_name in row.names(otu_table(ps.toptaxa))){
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
png(filename = paste0(path, "data/images/plots/", sample_name, "_toptaxa.png"), width = 800, height = 600)
plot <- plot_bar(ps.toptaxa_sample, x = "taxa", y = "Abundance", fill = "taxa", title = paste0("Most abundant taxa for sample ",sample_name))
print(plot)
dev.off()
}
system(paste("echo Saving taxonomy table and blast output..."))
tax_table1<-"data/taxtable.txt"
write.table(taxtab, file=paste0(path,tax_table1))
tax_tablecsv<-"data/taxtable.csv"
write.csv(taxtab, file=paste0(path,tax_tablecsv)) # just so it can be easily read by excel
# same thing for blasttable
blasttable <- read.table(paste0(path, blastout))
colnames(blasttable) <- c("qseq", "qid", "sid", "pident", "length", "mismatch", "gapopen", "qstart", "qend", "sstart", "send", "evalue", "bitscore")
blast_out<-"data-raw/blastout.csv"
write.csv(blasttable,file=paste0(path,blast_out))
system(paste("echo ##### Analysis Complete #####"))
create_report <- function(sample,top,sec){
rmarkdown::render(input = paste0(path0,"/MitoSonar_report.Rmd"),
output_format = rmarkdown::pdf_document(),
output_file = paste0(sample,"_MSReport"),
output_dir = paste0(path,"reports"),
intermediates_dir = paste0(path,"reports"),
clean = TRUE,
params = list(sample = sample,
maxN = maxN,
truncQ = truncQ,
truncLen = truncLen,
trimLeft = trimLeft,
maxEE = maxEE,
species = top,
species2 = sec))
}
rep_dir <- paste0(path,"reports")
if(!dir.exists(rep_dir)){dir.create(rep_dir)}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"reports/work-dir"))
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"reports/work-dir"))
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
capabilities()
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
tinytex::reinstall_tinytex(repository = "illinois")
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
?knitr::opts_chunk
str(knitr::opts_chunk$get())
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"reports/work-dir"))
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"reports/work-dir"))
for (sample_name in sam_names) {
ps.toptaxa_sample <- prune_samples(sample_name, ps.toptaxa)
otu_data <- as.data.frame(otu_table(ps.toptaxa_sample))
topseq <- names(otu_data)[which.max(otu_data)]
toptaxa <- tax_table(ps.toptaxa_sample)[topseq]
sectaxas <- c()
for (seq in (setdiff(names(otu_data), topseq))) {
if (otu_data[seq] >= 0.1) {
secseq <- seq
sectaxas <- append(sectaxas,tax_table(ps.toptaxa_sample)[secseq])
}
}
#print(sample_name)
#print(paste0("Top taxa: ",toptaxa))
#print(paste0("Other relevant taxas: ",paste(sectaxas, collapse = ", ")))
#print("-----")
create_report(sample_name,toptaxa,sectaxas)
}
system(paste0("rm -r ",path,"reports/work-dir"))
